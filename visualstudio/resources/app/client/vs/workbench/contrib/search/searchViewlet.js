/*---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------*/
"use strict";var __extends=this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n};define("vs/workbench/contrib/search/searchModel",["require","exports","vs/base/network","vs/base/time/schedulers","vs/base/strings","vs/base/paths","vs/base/lifecycle","vs/base/collections","vs/base/eventEmitter","vs/editor/editor","vs/editor/core/range","vs/editor/core/constants"],function(e,t,n,r,i,o,s,a,l,c,u,d){var p=function(){function e(e,t,n,r,i){this._parent=e,this._lineText=t,this._id=e.id()+">"+n+">"+r,this._range=new u.Range(1+n,1+r,1+n,1+r+i)}return e.prototype.id=function(){return this._id},e.prototype.parent=function(){return this._parent},e.prototype.text=function(){return this._lineText},e.prototype.range=function(){return this._range},e.prototype.preview=function(){var e=this._lineText.substring(0,this._range.startColumn-1),t=this._lineText.substring(this._range.startColumn-1,this._range.endColumn-1),n=this._lineText.substring(this._range.endColumn-1,Math.min(this._range.endColumn+150,this._lineText.length));return e=i.lcut(e,26),{before:e,inside:t,after:n}},e}();t.Match=p;var h=function(e){function t(t){e.call(this,t,null,Date.now(),Date.now(),Date.now())}return __extends(t,e),t}(p);t.EmptyMatch=h;var m=function(){function e(e,t){this._resource=t,this._parent=e,this._matches=Object.create(null)}return e.prototype.dispose=function(){},e.prototype.id=function(){return this.resource().toString()},e.prototype.parent=function(){return this._parent},e.prototype.add=function(e){this._matches[e.id()]=e},e.prototype.remove=function(e){delete this._matches[e.id()]},e.prototype.matches=function(){return a.values(this._matches)},e.prototype.count=function(){return Object.keys(this._matches).length},e.prototype.resource=function(){return this._resource},e.prototype.name=function(){return o.basename(this.resource().path)},e}();t.FileMatch=m;var f=function(e){function t(t,n,i,o,s){var a=this;e.call(this,t,n),this._modelDecorations=[],this._unbind=[],this._query=i,this._model=o,this._serverFileMatch=s,this._updateScheduler=new r.RunOnceScheduler(this._updateMatches.bind(this),250),this._unbind.push(this._model.addListener(d.EventType.ModelContentChanged,function(){return a._updateScheduler.schedule()})),this._updateMatches()}return __extends(t,e),t.prototype.dispose=function(){this._unbind=s.cAll(this._unbind),this._isTextModelDisposed()||this._model.deltaDecorations(this._modelDecorations,[])},t.prototype._updateMatches=function(){var e=this;if(!this._isTextModelDisposed()){this._matches=Object.create(null);var t=this._model.findMatches(this._query.pattern,this._model.getFullModelRange(),this._query.isRegExp,this._query.isCaseSensitive,this._query.isWordMatch);0===t.length?this.add(new h(this)):t.forEach(function(t){return e.add(new p(e,e._model.getLineContent(t.startLineNumber),t.startLineNumber-1,t.startColumn-1,t.endColumn-t.startColumn))}),this.parent().emit("changed",this),this.updateHighlights()}},t.prototype.updateHighlights=function(){this._model.isDisposed()||(this._modelDecorations=this.parent()._showHighlights?this._model.deltaDecorations(this._modelDecorations,this.matches().map(function(e){return{range:e.range(),options:t.DecorationOption}})):this._model.deltaDecorations(this._modelDecorations,[]))},t.prototype._isTextModelDisposed=function(){return!this._model||this._model.isDisposed()},t.DecorationOption={stickiness:c.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,isOverlay:!1,className:"findMatch",overviewRuler:{color:"rgba(246, 185, 77, 0.7)",position:c.OverviewRulerLane.Center}},t}(m);t.LiveFileMatch=f;var g=function(e){function t(t,n){void 0===n&&(n=null),e.call(this),this._disposables=[],this._matches=Object.create(null),this._instantiationService=t.instantiationService,this._contextService=t.contextService,this._requestService=t.requestService,this._modelService=t.modelService,this._query=n,this._query&&(this._modelService.onModelAdded.add(this._onModelAdded,this,this._disposables),this._modelService.onModelRemoved.add(this._onModelRemoved,this,this._disposables))}return __extends(t,e),t.prototype._onModelAdded=function(e){var t=this._requestService.getPath("root",e.getAssociatedResource()),n=this._contextService.toResource(t);if(n){var r=this._matches[n.toString()];if(r){var i=new f(this,n,this._query,e,r);i.updateHighlights(),this._matches[n.toString()]=i,this.emit("changed",this)}}},t.prototype._onModelRemoved=function(e){var t=this,n=this._requestService.getPath("root",e.getAssociatedResource()),r=this._contextService.toResource(n);if(r){var i=this._matches[r.toString()];i instanceof f&&this.deferredEmit(function(){t.remove(i),t._matches[r.toString()]=i._serverFileMatch})}},t.prototype.append=function(e){var t=this;e.forEach(function(e){var n=t._getOrAdd(e);n instanceof f&&(n=n._serverFileMatch),e.lineMatches.forEach(function(e){e.offsetAndLengths.forEach(function(t){var r=new p(n,e.preview,e.lineNumber,t[0],t[1]);n.add(r)})})})},t.prototype._getOrAdd=function(e){var t=this;return a.lookupOrInsert(this._matches,e.resource.toString(),function(){var r,i,o=t._contextService.toWorkspaceRelativePath(e.resource);r=o?n.URL.fromValue(t._requestService.getRequestUrl("root",o,!0)):n.URL.fromValue(e.resource.toString()),i=t._modelService.getModel(r);var s=new m(t,e.resource);return i&&t._query&&(s=new f(t,e.resource,t._query,i,s)),s})},t.prototype.remove=function(e){delete this._matches[e.resource().toString()],e.dispose(),this.emit("changed",this)},t.prototype.matches=function(){return a.values(this._matches)},t.prototype.isEmpty=function(){return 0===this.fileCount()},t.prototype.fileCount=function(){return Object.keys(this._matches).length},t.prototype.count=function(){return this.matches().reduce(function(e,t){return e+t.count()},0)},t.prototype.toggleHighlights=function(e){if(this._showHighlights!==e){this._showHighlights=e;for(var t in this._matches){var n=this._matches[t];n instanceof f&&n.updateHighlights()}}},t.prototype.dispose=function(){this._disposables=s.disposeAll(this._disposables),s.disposeAll(this.matches()),e.prototype.dispose.call(this)},t}(l.EventEmitter);t.SearchResult=g}),define("vs/workbench/contrib/search/searchQuery",["require","exports","vs/base/assert","vs/base/types","vs/base/lib/winjs.base","vs/base/lifecycle","vs/platform/services"],function(e,t,n,r,i,o,s){var a=function(){function e(e){var t=this;this.configurationService=e.configurationService,this.contextService=e.contextService,this.callOnDispose=[],e?this.callOnDispose.push(this.configurationService.addListener(s.ConfigurationServiceEventTypes.UPDATED,function(e){t.configurationPromise=i.Promise.as(t.readConfiguration(e.config))})):this.configurationPromise=i.Promise.as(new Array)}return e.prototype.dispose=function(){o.cAll(this.callOnDispose)},e.prototype.text=function(e,t,n,r,i,o){return this._query(s.Search.QueryType.Text,e,t,n,r,i,o)},e.prototype.file=function(e,t,n,r){return this._query(s.Search.QueryType.File,null,e,t,n,void 0,r)},e.prototype._query=function(e,t,n,o,s,a,c){var u=this;return this.contextService.getWorkspace()?this.getExcludedFoldersFromConfiguration().then(function(i){return r.isUndefinedOrNull(s)||(i=i.slice(0),s.forEach(function(e){var t=u.contextService.toWorkspaceRelativePath(e);if(t){var n=i.indexOf(t);n>=0&&i.splice(n,1)}})),r.isUndefinedOrNull(o)?o=i.map(function(e){return u.contextService.toResource(e)}):o.push.apply(o,i.map(function(e){return u.contextService.toResource(e)})),new l(e,t,n,o,s,a,c)}):i.Promise.as(new l(e,t,n,[],[],a,c))},e.prototype.getExcludedFoldersFromConfiguration=function(){var e=this;return this.configurationPromise?this.configurationPromise:(this.configurationPromise=this.configurationService.loadConfiguration().then(function(t){return e.readConfiguration(t)}),this.configurationPromise)},e.prototype.readConfiguration=function(t){var n=t&&t.search&&t.search.excludeFolders;return n&&Array.isArray(n)||(n=e.DefaultExclusionList),n},e.DefaultExclusionList=[".git","node_modules"],e}();t.QueryBuilder=a;var l=function(){function e(e,t,i,o,a,l,c){n.ok(!r.isUndefinedOrNull(e)),n.ok(e!==s.Search.QueryType.Text||t&&t.pattern&&0!==t.pattern.length),this._type=e,this._contentPattern=t,this._filePatterns=i||[],this._excludeResources=o||[],this._includeResources=a||[],this._maxResults=l,this._extraResources=c}return Object.defineProperty(e.prototype,"type",{get:function(){return this._type},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentPattern",{get:function(){return this._contentPattern},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filePatterns",{get:function(){return this._filePatterns},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"excludeResources",{get:function(){return this._excludeResources},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"includeResources",{get:function(){return this._includeResources},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extraResources",{get:function(){return this._extraResources},enumerable:!0,configurable:!0}),e.prototype.toJSON=function(){return{type:this.type,contentPattern:this.contentPattern,filePatterns:this.filePatterns,excludeResources:this._excludeResources,includeResources:this._includeResources,maxResults:this._maxResults,extraResources:this._extraResources}},e}()}),define("vs/css!vs/workbench/contrib/search/media/searchviewlet",["vs/css!vs/workbench/contrib/search/searchViewlet"],{});var __extends=this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n};define("vs/workbench/contrib/search/searchViewlet",["require","exports","vs/base/lib/winjs.base","vs/nls!vs/workbench/contrib/search/searchViewlet","vs/base/env","vs/editor/core/range","vs/base/lifecycle","vs/platform/services","vs/base/errors","vs/base/assert","vs/base/types","vs/base/strings","vs/base/ui/labels","vs/base/dom/dom","vs/base/ui/actions","vs/base/dom/keyboardEvent","vs/base/performance/timer","vs/base/dom/builder","vs/base/ui/widgets/fileLabel","vs/base/ui/widgets/findInput","vs/base/ui/widgets/leftRightWidget/leftRightWidget","vs/base/ui/widgets/countBadge/countBadge","vs/base/ui/widgets/tree/treeImpl","vs/base/ui/widgets/tree/treeDefaults","vs/base/ui/widgets/tree/actionsRenderer","vs/workbench/ui/actionBarRegistry","vs/editor/core/constants","vs/workbench/core/memento","vs/workbench/events","vs/workbench/ui/parts/viewlet","vs/workbench/contrib/search/searchModel","./searchQuery","vs/workbench/contrib/search/search.contribution","vs/base/ui/widgets/inputBox","vs/css!./media/searchviewlet"],function(e,t,n,r,i,o,s,a,l,c,u,d,p,h,m,f,g,v,b,y,_,w,S,E,T,k,C,x,A,L,I,N,M,P){var O=v.$,R=M.VIEWLET_ID,D=function(e){function t(t,n){e.call(this,"workbench.search.action.findInFolder",r.localize("vs_workbench_contrib_search_searchViewlet",0)),this.viewletService=t.viewletService,this.resource=n}return __extends(t,e),t.prototype.run=function(){var e=this;return this.viewletService.openViewlet(R,!0).then(function(t){t.searchInFolder(e.resource)})},t}(m.Action);t.FindInFolderAction=D;var F=function(){function e(){}return e.prototype.getId=function(e,t){return t instanceof I.FileMatch?t.id():t instanceof I.Match?t.id():t instanceof I.SearchResult?"root":(c.ok(!1),void 0)},e.prototype.getChildren=function(e,t){var r=[];return t instanceof I.FileMatch?r=t.matches():t instanceof I.SearchResult&&(r=t.matches()),n.Promise.as(r)},e.prototype.hasChildren=function(e,t){return t instanceof I.FileMatch||t instanceof I.SearchResult},e.prototype.getParent=function(e,t){var r=null;return t instanceof I.Match?r=t.parent():t instanceof I.FileMatch&&(r=t.parent()),n.Promise.as(r)},e}();t.SearchDataSource=F;var V=function(){function e(){}return e.prototype.compare=function(e,t,n){return t instanceof I.FileMatch&&n instanceof I.FileMatch?d.localeCompare(t.resource().path,n.resource().path)||d.localeCompare(t.name(),n.name()):t instanceof I.Match&&n instanceof I.Match?o.compareRangesUsingStarts(t.range(),n.range()):void 0},e}();t.SearchSorter=V;var B=function(e){function t(){var t=this;e.call(this,{clickBehavior:E.ClickBehavior.ON_MOUSE_DOWN}),this.downKeyBindings.Delete=function(e,n){t.onDelete(e,n)}}return __extends(t,e),t.prototype.onDelete=function(e){for(var t=!1,n=e.getSelection(),r=0;r<n.length;r++){var i=n[r];i instanceof I.Match&&(new U(e,i).run().done(null,l.onUnexpectedError),t=!0)}return t},t}(E.DefaultController),H=function(){function e(){}return e.prototype.isVisible=function(e,t){return!(t instanceof I.FileMatch)||t.matches().length>0},e}(),W=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.hasActions=function(t,n){return n instanceof I.FileMatch||e.prototype.hasActions.call(this,t,n)},t.prototype.getActions=function(t,n){return e.prototype.getActions.call(this,t,n).then(function(e){return n instanceof I.FileMatch&&e.unshift(new U(t,n)),e})},t}(k.ContributableActionProvider),U=function(e){function t(t,n){e.call(this,"remove",r.localize("vs_workbench_contrib_search_searchViewlet",1),"action-remove"),this._viewer=t,this._fileMatch=n}return __extends(t,e),t.prototype.run=function(){var e=this._fileMatch.parent();return e.remove(this._fileMatch),this._viewer.refresh(e)},t}(m.Action),j=function(e){function t(t,n){e.call(this,{actionProvider:new W,actionRunner:n}),this._contextService=t.contextService}return __extends(t,e),t.prototype.getContentHeight=function(){return 24},t.prototype.renderContents=function(e,t,n){var i=this;if(t instanceof I.FileMatch){var o,s,a,l=t,c=O(".filematch");return o=function(e){return new b.FileLabel(e,l.resource(),i._contextService),null},s=function(e){var t=l.count();return new w.CountBadge(e,t,t>1?r.localize("vs_workbench_contrib_search_searchViewlet",2,t):r.localize("vs_workbench_contrib_search_searchViewlet",3,t))},a=new _.LeftRightWidget(c,o,s),c.appendTo(n),a.dispose.bind(a)}if(t instanceof I.EmptyMatch)h.addClass(n,"linematch"),O("a.plain.label").innerHtml(r.localize("vs_workbench_contrib_search_searchViewlet",4)).appendTo(n);else if(t instanceof I.Match){h.addClass(n,"linematch");var u=[],p=t.preview();u.push("<span>"),u.push(d.escape(p.before)),u.push('</span><span class="findInFileMatch">'),u.push(d.escape(p.inside)),u.push("</span><span>"),u.push(d.escape(p.after)),u.push("</span>"),O("a.plain").innerHtml(u.join(d.empty)).appendTo(n)}return null},t}(T.ActionsRenderer),$=function(e){function t(t){e.call(this,"refresh"),this.label=r.localize("vs_workbench_contrib_search_searchViewlet",5),this.enabled=!1,this.class="search-action refresh",this.viewlet=t}return __extends(t,e),t.prototype.run=function(){return this.viewlet.onQueryChanged(),n.Promise.as(null)},t}(m.Action);t.RefreshAction=$;var z=function(e){function t(t){e.call(this,"selectOrRemove"),this.label=r.localize("vs_workbench_contrib_search_searchViewlet",6),this.enabled=!1,this.selectMode=!0,this.viewlet=t}return __extends(t,e),t.prototype.run=function(){var e;return e=this.selectMode?this.runAsSelect():this.runAsRemove(),this.selectMode=!this.selectMode,this.label=this.selectMode?r.localize("vs_workbench_contrib_search_searchViewlet",7):r.localize("vs_workbench_contrib_search_searchViewlet",8),e},t.prototype.runAsSelect=function(){return this.viewlet.getResults().addClass("select"),n.Promise.as(null)},t.prototype.runAsRemove=function(){var e=[],t=this.viewlet.getControl();return t.getInput().matches().forEach(function(t){t.matches().filter(function(e){return e.$checked}).forEach(function(t){t.parent().remove(t),e.push(t.parent())})}),this.viewlet.getResults().removeClass("select"),e.length>0?t.refreshAll(e).then(function(){return t.refresh()}):n.Promise.as(null)},t}(m.Action);t.SelectOrRemoveAction=z;var G=function(e){function t(t){e.call(this,"collapseAll"),this.label=r.localize("vs_workbench_contrib_search_searchViewlet",9),this.enabled=!1,this.class="search-action collapse",this.viewlet=t}return __extends(t,e),t.prototype.run=function(){return this.viewlet.getControl()?this.viewlet.getControl().collapseAll():n.Promise.as(null)},t}(m.Action);t.CollapseAllAction=G;var q=function(e){function t(t){e.call(this,"clearSearchResults"),this.label=r.localize("vs_workbench_contrib_search_searchViewlet",10),this.enabled=!1,this.class="search-action clear-search-results",this.viewlet=t}return __extends(t,e),t.prototype.run=function(){return this.viewlet.clearSearchResults(),n.Promise.as(null)},t}(m.Action);t.ClearSearchResultsAction=q;var K=function(e){function t(t){var n=this;e.call(this,t,R),this.eventService=t.eventService,this.editorService=t.editorService,this.progressService=t.progressService,this.messageService=t.messageService,this.storageService=t.storageService,this.contextViewService=t.contextViewService,this.instantiationService=t.instantiationService,this.configurationService=t.configurationService,this.searchServices=t.textFileSearchService,this.textFileService=t.textFileService,this.contextService=t.contextService,this._viewletVisible=t.keybindingService.createKey("searchViewletVisible",!0),this.callOnModelChange=[],this.queryBuilder=this.instantiationService.createInstance(N.QueryBuilder),this.loadSettings(this.storageService),this.toUnbind.push(this.eventService.addListener(a.Files.EventType.FILE_CHANGES,function(e){return n.onFilesChanged(e)})),this.toUnbind.push(this.eventService.addListener(A.EventType.UNTITLED_FILE_DELETED,function(e){return n.onUntitledFileDeleted(e)})),this.toUnbind.push(this.configurationService.addListener(a.ConfigurationServiceEventTypes.UPDATED,function(e){return n.onConfigurationUpdated(e.config)}))}return __extends(t,e),t.prototype.onConfigurationUpdated=function(e){this.updateGlobalFolderExclusions(e)},t.prototype.loadSettings=function(e){var t=this;this.viewletSettings||this.loadMemento(e,x.Scope.WORKSPACE).done(function(e){t.viewletSettings=e},l.onUnexpectedError)},t.prototype.getResults=function(){return this.results},t.prototype.create=function(t){var i=this;e.prototype.create.call(this,t);var o,s=this.viewletSettings["query.filePatterns"]||"",a=this.viewletSettings["query.folderExclusions"]||"",c=this.viewletSettings["query.folderIncludes"]||"",u=this.viewletSettings["query.contentPattern"]||"",p=this.viewletSettings["query.regex"]===!0,m=this.viewletSettings["query.wholeWords"]===!0,g=this.viewletSettings["query.caseSensitive"]===!0;this.domNode=t.div({class:"search-viewlet"},function(e){o=e});var v=function(e){var t=new f.KeyboardEvent(e);"Enter"===t.key&&i.onQueryChanged()};this.queryBox=o.div({class:"query-box"},function(e){var t={label:r.localize("vs_workbench_contrib_search_searchViewlet",11),validation:function(e){if(0===e.length)return null;if(!i.findInput.getRegex())return null;var t;try{t=new RegExp(e)}catch(n){return{content:n.message}}return d.regExpLeadsToEndlessLoop(t)?{content:r.localize("vs_workbench_contrib_search_searchViewlet",12)}:void 0}};i.findInput=new y.FindInput(e.getHTMLElement(),i.contextViewService,t).on(h.EventType.KEY_UP,v).on(h.EventType.KEY_DOWN,function(e){var t=new f.KeyboardEvent(e);"DownArrow"===t.key&&(h.EventHelper.stop(e),i.showsFileTypes()?i.toggleFileTypes(!0):i.selectTreeIfNotSelected(t))}).on(y.FindInput.OPTION_CHANGE,function(){i.onQueryChanged()}),i.findInput.setValue(u),i.findInput.setRegex(p),i.findInput.setCaseSensitive(g),i.findInput.setWholeWords(m)}).style({position:"relative"}).getHTMLElement(),this.queryDetails=o.div({class:["query-details","separator"]},function(e){e.div({class:"more",text:"â€¦"}).on(h.EventType.CLICK,function(e){h.EventHelper.stop(e),i.toggleFileTypes()}),e.div({class:"file-types"},function(e){var t=r.localize("vs_workbench_contrib_search_searchViewlet",13);e.element("h4",{text:t}),i.inputFileTypes=new P.InputBox(e.getContainer(),i.contextViewService,{placeholder:r.localize("vs_workbench_contrib_search_searchViewlet",14),ariaLabel:t}),i.inputFileTypes.value=s,O(i.inputFileTypes.inputElement).on(h.EventType.KEY_UP,v).on(h.EventType.KEY_DOWN,function(e){var t=new f.KeyboardEvent(e);switch(t.asString()){case"UpArrow":h.EventHelper.stop(e),i.findInput.focus(),i.findInput.select();break;case"DownArrow":h.EventHelper.stop(e),i.inputFolderIncludes.focus()}})}),e.div({class:"file-types"},function(e){var t=r.localize("vs_workbench_contrib_search_searchViewlet",15);e.element("h4",{text:t}),i.inputFolderIncludes=new P.InputBox(e.getContainer(),i.contextViewService,{placeholder:r.localize("vs_workbench_contrib_search_searchViewlet",16),ariaLabel:t}),i.inputFolderIncludes.value=c,O(i.inputFolderIncludes.inputElement).on(h.EventType.KEY_UP,v).on(h.EventType.KEY_DOWN,function(e){var t=new f.KeyboardEvent(e);switch(t.asString()){case"UpArrow":h.EventHelper.stop(e),i.inputFileTypes.focus();break;case"DownArrow":h.EventHelper.stop(e),i.inputFolderExclusions.focus()}})}),e.div({class:"file-types"},function(e){var t=r.localize("vs_workbench_contrib_search_searchViewlet",17);e.element("h4",{text:t}),i.inputFolderExclusions=new P.InputBox(e.getContainer(),i.contextViewService,{placeholder:r.localize("vs_workbench_contrib_search_searchViewlet",18),ariaLabel:t}),i.inputFolderExclusions.value=a,O(i.inputFolderExclusions.inputElement).on(h.EventType.KEY_UP,v).on(h.EventType.KEY_DOWN,function(e){var t=new f.KeyboardEvent(e);switch(t.asString()){case"UpArrow":h.EventHelper.stop(e),i.inputFolderIncludes.focus();break;case"DownArrow":h.EventHelper.stop(e),i.selectTreeIfNotSelected(t)}})}),i.inputFolderGlobalExclusionsContainer=e.div({class:"file-types"},function(e){var t=r.localize("vs_workbench_contrib_search_searchViewlet",19);e.element("h4",{text:t}),i.inputFolderGlobalExclusions=new P.InputBox(e.getContainer(),i.contextViewService,{}),i.inputFolderGlobalExclusions.inputElement.readOnly=!0}).hide()}).getHTMLElement(),this.messages=o.div({class:"messages"}).hide().clone(),o.div({class:"results"},function(e){i.results=e;var t=new F,n=i.instantiationService.createInstance(j,i.getActionRunner());i.tree=new S.Tree(e.getHTMLElement(),{dataSource:t,renderer:n,sorter:new V,filter:new H,controller:new B},{paddingLeft:12,allowHorizontalScroll:!1}),i.toUnbind.push(function(){return n.dispose()}),i.toUnbind.push(i.tree.addListener("selection",function(e){var t,n=e.payload&&"keyboard"===e.payload.origin;t=n?i.tree.getFocus():e.selection[0];var r=e&&e.payload&&e.payload.originalEvent&&(e.payload.originalEvent.ctrlKey||e.payload.originalEvent.metaKey);i.onFocus(t,!n,r)}))}),this.actionRegistry={};var b=[new G(this),new $(this),new q(this),new z(this)];return b.forEach(function(e){i.actionRegistry[e.id]=e}),(""!==s||""!==a||""!==c)&&this.toggleFileTypes(!0,!0),this.configurationService.loadConfiguration().then(function(e){i.updateGlobalFolderExclusions(e)}).done(null,l.onUnexpectedError),n.Promise.as(null)},t.prototype.updateGlobalFolderExclusions=function(e){if(this.inputFolderGlobalExclusionsContainer){var t=e.search?e.search.excludeFolders:[];t.length?(this.inputFolderGlobalExclusions.value=t.join(", "),this.inputFolderGlobalExclusionsContainer.show()):this.inputFolderGlobalExclusionsContainer.hide()}},t.prototype.setVisible=function(t){var n;if(this._viewletVisible.set(t),t?(n=e.prototype.setVisible.call(this,t),this.tree.onVisible()):(this.tree.onHidden(),n=e.prototype.setVisible.call(this,t)),t||(this.focusInput=!0),this.viewModel&&this.viewModel.toggleHighlights(t),t&&!this.editorService.getActiveEditorInput()){var r=this.tree.getFocus();r&&this.onFocus(r,!1,!1)}return n},t.prototype.focus=function(){e.prototype.focus.call(this);var t=this.tree.getSelection();if(this.focusInput||0===t.length||this.tree.isDOMFocused()){var n=this.getSelectionFromEditor();n&&this.findInput.setValue(n),this.findInput.focus(),this.findInput.select(),delete this.focusInput}else this.tree.DOMFocus()},t.prototype.reLayout=function(){if(!this.isDisposed){this.findInput.setWidth(this.size.width-34);var e=h.getTotalHeight(this.queryBox),t=h.getTotalHeight(this.queryDetails),n=this.size.height-e-t;this.results.style({height:n+"px"}),this.tree.layout(n)}},t.prototype.layout=function(t){var r=this;this.size=t,e.prototype.layout.call(this,t),n.Promise.timeout(10).done(function(){r.reLayout()},l.onUnexpectedError)},t.prototype.getControl=function(){return this.tree},t.prototype.clearSearchResults=function(){this.disposeModel(),this.showEmptyStage(),this.findInput.clear(),this.currentRequest&&(this.currentRequest.cancel(),this.currentRequest=null)},t.prototype.selectTreeIfNotSelected=function(){if(this.tree.getInput()){this.tree.DOMFocus();var e=this.tree.getSelection();0===e.length&&this.tree.focusNext()}},t.prototype.getSelectionFromEditor=function(){if(!this.editorService.getActiveEditor())return null;var e=this.editorService.getActiveEditor().getControl();if(!e||!u.isFunction(e.getEditorType)||e.getEditorType()!==C.EditorType.ICodeEditor)return null;var t=e.getSelection();if(t&&!t.isEmpty()&&t.startLineNumber===t.endLineNumber){var n=e.getModel().getLineContent(t.startLineNumber);return n=n.substring(t.startColumn-1,t.endColumn-1)}return null},t.prototype.showsFileTypes=function(){return h.hasClass(this.queryDetails,"more")},t.prototype.toggleFileTypes=function(e,t){var n="more";e="undefined"==typeof e?!h.hasClass(this.queryDetails,n):Boolean(e),t=Boolean(t),e?(h.addClass(this.queryDetails,n),this.inputFileTypes.focus(),this.inputFileTypes.select()):h.removeClass(this.queryDetails,n),!t&&this.size&&this.layout(this.size)},t.prototype.searchInFolder=function(e){this.showsFileTypes()||this.toggleFileTypes(!0,!1),this.inputFolderIncludes.value=p.getPathLabel(e.path,this.contextService),this.findInput.focus()},t.prototype.onQueryChanged=function(){function e(e){return e.split(/[\s,]/).map(function(e){return e.trim()}).filter(function(e){return e.length>0})}var n=this,r=this.findInput.getRegex(),i=this.findInput.getWholeWords(),o=this.findInput.getCaseSensitive(),s=this.findInput.getValue(),a=this.inputFileTypes.value.trim(),c=this.inputFolderExclusions.value.trim(),u=this.inputFolderIncludes.value.trim();if(this.viewletSettings["query.contentPattern"]=s,this.viewletSettings["query.regex"]=r,this.viewletSettings["query.wholeWords"]=i,this.viewletSettings["query.caseSensitive"]=o,this.viewletSettings["query.filePatterns"]=a,this.viewletSettings["query.folderExclusions"]=c,this.viewletSettings["query.folderIncludes"]=u,/^\s+|\s$/.test(s)&&(s=d.escapeRegExpCharacters(s),r=!0),0!==s.length){if(r){var p;try{p=new RegExp(s)}catch(h){return}if(d.regExpLeadsToEndlessLoop(p))return}var m={pattern:s,isRegExp:r,isCaseSensitive:o,isWordMatch:i},f=e(a).map(function(e){return{pattern:e}}),g=e(c).map(function(e){return n.contextService.toResource(e)}),v=e(u).map(function(e){return n.contextService.toResource(e)}),b=this.textFileService.getWorkingFilesModel().getOutOfWorkspaceContextEntries().map(function(e){return e.resource});this.queryBuilder.text(m,f,g,v,t.MAX_TEXT_RESULTS,b).then(function(t){return n.onQueryTriggered(t,e(c))},l.onUnexpectedError)}},t.prototype.onQueryTriggered=function(e,n){var i=this;void 0===n&&(n=[]),this.currentRequest&&(this.currentRequest.cancel(),this.currentRequest=null);var o=this.telemetryService.start("searchResultsFirstRender"),s=this.telemetryService.start("searchResultsFinished"),a=100,c=this.progressService.show(a),u=0;this.loading=!0,this.findInput.clearMessage(),this.disposeModel(),this.showEmptyStage();var d=function(e){if(i.viewModel){var t=i.viewModel.matches();t.forEach(function(n){var r=n.matches().length;10>r||e&&1===t.length&&50>r?i.tree.expand(n).done(null,l.onUnexpectedError):i.tree.collapse(n).done(null,l.onUnexpectedError)})}},m=g.start(g.Topic.WORKBENCH,"Search"),f=!1,v=function(o){m.stop(),f=!0,c.worked(a-u),setTimeout(function(){return c.done()},200),i.viewModel=i.viewModel||i.instantiationService.createInstance(I.SearchResult,e.contentPattern),i.viewModel.append(o),i.tree.refresh().then(function(){d(!0)}).done(void 0,l.onUnexpectedError);var g=!i.viewModel.isEmpty();if(i.loading=!1,i.telemetryService.publicLog("searchResultsShown",{count:i.viewModel.count(),fileCount:i.viewModel.fileCount()}),i.actionRegistry.refresh.enabled=!0,i.actionRegistry.selectOrRemove.enabled=g,i.actionRegistry.collapseAll.enabled=g,i.actionRegistry.clearSearchResults.enabled=g,i.viewModel.count()>=t.MAX_TEXT_RESULTS&&i.findInput.showMessage({content:r.localize("vs_workbench_contrib_search_searchViewlet",20),type:P.MessageType.WARNING}),g)i.viewModel.toggleHighlights(!0);else{var v,b=!!i.contextService.getWorkspace(),y=b&&n.length>0,_=b&&!!e.excludeResources&&e.excludeResources.length>n.length,w=b&&e.includeResources&&e.includeResources.length>0,S=e.filePatterns&&e.filePatterns.length>0,E=new p.PathLabelProvider(i.contextService);v=S&&w?r.localize("vs_workbench_contrib_search_searchViewlet",21,e.includeResources.map(function(e){return E.getLabel(e)}).join(", "),e.filePatterns.map(function(e){return e.pattern}).join(", ")):S?r.localize("vs_workbench_contrib_search_searchViewlet",22,e.filePatterns.map(function(e){return e.pattern}).join(", ")):w?r.localize("vs_workbench_contrib_search_searchViewlet",23,e.includeResources.map(function(e){return E.getLabel(e)}).join(", ")):y?r.localize("vs_workbench_contrib_search_searchViewlet",24,n.map(function(e){return E.getLabel(i.contextService.toResource(e))}).join(", ")):_?r.localize("vs_workbench_contrib_search_searchViewlet",25):r.localize("vs_workbench_contrib_search_searchViewlet",26),i.tree.onHidden(),i.results.hide();var T=i.messages.empty().show().asContainer().div({class:"message",text:v});(S||w||y)&&O(T).a({class:["pointer","prominent"],text:r.localize("vs_workbench_contrib_search_searchViewlet",27)}).on(h.EventType.CLICK,function(e){h.EventHelper.stop(e,!1),i.inputFileTypes.value="",i.inputFolderExclusions.value="",i.inputFolderIncludes.value="",i.onQueryChanged()})}s.stop()},b=function(e){i.loading=!1,f=!0,c.done(),o.stop(),s.stop(),e&&"Canceled"===e.message||i.messageService.show(2,e)},y=0,_=0,w=0,S=[],E=function(t){t.total&&(y=t.total),t.worked&&(_=t.worked),t.resource&&(S.push(t),i.viewModel||(i.viewModel=i.instantiationService.createInstance(I.SearchResult,e.contentPattern),i.tree.setInput(i.viewModel).then(function(){d(!1),i.callOnModelChange.push(i.viewModel.addListener("changed",function(e){return i.tree.refresh(e,!0)}))}).done(null,l.onUnexpectedError)),i.viewModel.append(S),o.stop())},T=setInterval(function(){if(f)return window.clearInterval(T),void 0;var e=!0;if(y>0&&_>0){var t=Math.round(_/y*100);t>u&&(c.worked(t-u),u=t,e=!1)}e&&90>u&&(u++,c.worked(1)),w!==S.length&&(w=S.length,i.tree.refresh().then(function(){d(!1)}).done(null,l.onUnexpectedError))},200);this.currentRequest=this.searchServices.search(e),this.currentRequest.then(v,b,E)},t.prototype.showEmptyStage=function(){this.actionRegistry.refresh.enabled=!1,this.actionRegistry.selectOrRemove.enabled=!1,this.actionRegistry.collapseAll.enabled=!1,this.actionRegistry.clearSearchResults.enabled=!1,this.messages.hide(),this.tree.setInput(this.instantiationService.createInstance(I.SearchResult)).done(null,l.onUnexpectedError),this.results.show(),this.tree.onVisible()},t.prototype.onFocus=function(e,t,r){if(!(e instanceof I.Match))return n.Promise.as(!0);var i=e.parent().resource(),o=e.range();return this.telemetryService.publicLog("searchResultChosen"),this.editorService.openEditor({resource:i,options:{preserveFocus:t,selection:o}},r)},t.prototype.onUntitledFileDeleted=function(e){if(this.viewModel)for(var t=this.viewModel.matches(),n=0,r=t.length;r>n;n++)e.resource.toString()===t[n].resource().toString()&&this.viewModel.remove(t[n])},t.prototype.onFilesChanged=function(e){if(this.viewModel)for(var t=this.viewModel.matches(),n=0,r=t.length;r>n;n++)e.contains(t[n].resource(),a.Files.FileChangeType.DELETED)&&this.viewModel.remove(t[n])},t.prototype.getSelection=function(){return new a.StructuredSelection(this.tree.getSelection())
},t.prototype.getActions=function(){return[this.actionRegistry.refresh,this.actionRegistry.collapseAll,this.actionRegistry.clearSearchResults]},t.prototype.dispose=function(){this.isDisposed=!0,this.tree&&this.tree.dispose(),this.disposeModel(),e.prototype.dispose.call(this)},t.prototype.disposeModel=function(){this.viewModel&&(this.viewModel.dispose(),this.viewModel=null),s.cAll(this.callOnModelChange)},t.MAX_TEXT_RESULTS=i.isWeb?1024:2048,t}(L.Viewlet);t.SearchViewlet=K});